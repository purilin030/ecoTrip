<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EcoTrip ä¸­å¤®æ§åˆ¶å°</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; }
        .header { text-align: center; margin-bottom: 40px; }
        .header h1 { color: #00695C; margin: 0; }
        .header p { color: #666; }
        
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; max-width: 1200px; margin: 0 auto; }
        
        /* å¡ç‰‡æ ·å¼ */
        .card { background: white; border-radius: 12px; padding: 25px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); transition: transform 0.2s; text-align: center; }
        .card:hover { transform: translateY(-5px); box-shadow: 0 8px 15px rgba(0,0,0,0.1); }
        .icon { font-size: 40px; margin-bottom: 15px; display: block; }
        
        .btn { padding: 12px 25px; border: none; border-radius: 6px; font-size: 16px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 15px; transition: background 0.3s; }
        .btn-sync { background: #0288D1; color: white; }
        .btn-sync:hover { background: #0277BD; }
        .btn-archive { background: #E65100; color: white; }
        .btn-archive:hover { background: #EF6C00; }
        .btn-monitor { background: #2E7D32; color: white; }
        .btn-monitor:hover { background: #388E3C; }
        
        .log-box { background: #f8f9fa; border: 1px solid #ddd; padding: 10px; margin-top: 15px; font-size: 12px; text-align: left; height: 100px; overflow-y: auto; border-radius: 4px; display: none; }
    </style>
</head>
<body>

    <div class="header">
        <h1>ğŸŒ± EcoTrip äº‘ç«¯æŒ‡æŒ¥ä¸­å¿ƒ</h1>
        <p>æ··åˆæ¶æ„æ•°æ®åŒæ­¥ä¸ç›‘æ§ç³»ç»Ÿ</p>
    </div>

    <div class="grid">
        <!-- 1. å‘å¸ƒæŒ‘æˆ˜ -->
        <div class="card">
            <span class="icon">ğŸ“¤</span>
            <h2>å‘å¸ƒæŒ‘æˆ˜</h2>
            <p style="color:#666; font-size:14px;">MySQL (Local) â” Firebase (Cloud)</p>
            <p>å°† PHP åå°åˆ›å»ºçš„æ–°æŒ‘æˆ˜ï¼Œæ¨é€è‡³ App ç«¯ã€‚</p>
            <button class="btn btn-sync" onclick="runSyncChallenges(this)">ğŸš€ å¼€å§‹å‘å¸ƒ</button>
            <div class="log-box" id="log-challenge"></div>
        </div>

        <!-- 2. æ•°æ®å½’æ¡£ -->
        <div class="card">
            <span class="icon">ğŸ“¥</span>
            <h2>æ•°æ®å½’æ¡£</h2>
            <p style="color:#666; font-size:14px;">Firebase (Cloud) â” MySQL (Local)</p>
            <p>å°† App äº§ç”Ÿçš„ç”¨æˆ·æäº¤è®°å½•ï¼ŒæŠ“å–å›æœ¬åœ°æ•°æ®åº“ã€‚</p>
            <button class="btn btn-archive" onclick="runSyncBack(this)">ğŸ’¾ å¼€å§‹å½’æ¡£</button>
            <div class="log-box" id="log-archive"></div>
        </div>

        <!-- 3. å®æ—¶ç›‘æ§ -->
        <div class="card">
            <span class="icon">ğŸ“º</span>
            <h2>å®æ—¶ç›‘æ§å¢™</h2>
            <p style="color:#666; font-size:14px;">Real-time Dashboard</p>
            <p>æŸ¥çœ‹ App ç«¯å®æ—¶ä¸Šä¼ çš„ç…§ç‰‡æµã€‚</p>
            <a href="admin_monitor.php" target="_blank">
                <button class="btn btn-monitor">ğŸ‘ï¸ æ‰“å¼€ç›‘æ§å°</button>
            </a>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, getDocs, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // ğŸ”´ ä½ çš„ Config
        const firebaseConfig = {
            apiKey: "ä½ çš„API_KEY",
            authDomain: "ecotrip-miniproject.firebaseapp.com",
            projectId: "ecotrip-miniproject",
            storageBucket: "ecotrip-miniproject.firebasestorage.app",
            messagingSenderId: "...",
            appId: "..."
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- 1. å‘å¸ƒæŒ‘æˆ˜é€»è¾‘ ---
        window.runSyncChallenges = async (btn) => {
            const logBox = document.getElementById('log-challenge');
            logBox.style.display = 'block';
            logBox.innerHTML = "â³ è¿æ¥ PHP æ¥å£...";
            btn.disabled = true;

            try {
                const response = await fetch('api/export_challenges.php');
                const challenges = await response.json();
                logBox.innerHTML += `<br>âœ… è¯»å–åˆ° ${challenges.length} ä¸ªæŒ‘æˆ˜`;

                for (const c of challenges) {
                    await setDoc(doc(db, "challenges", c.Challenge_ID), {
                        id: c.Challenge_ID,
                        title: c.Title,
                        desc: c.Detailed_Description,
                        difficulty: c.Difficulty,
                        points: parseInt(c.Points),
                        category: c.CategoryName
                    });
                }
                logBox.innerHTML += `<br>ğŸ‰ åŒæ­¥å®Œæˆï¼`;
            } catch (e) {
                logBox.innerHTML += `<br>âŒ é”™è¯¯: ${e.message}`;
            } finally {
                btn.disabled = false;
            }
        };

        // --- 2. æ•°æ®å½’æ¡£é€»è¾‘ ---
        window.runSyncBack = async (btn) => {
            const logBox = document.getElementById('log-archive');
            logBox.style.display = 'block';
            logBox.innerHTML = "â³ æ‰«æ Firebase...";
            btn.disabled = true;

            try {
                const snapshot = await getDocs(collection(db, "submissions"));
                let count = 0;
                
                for (const docSnap of snapshot.docs) {
                    const data = docSnap.data();
                    if (data.synced) continue; // è·³è¿‡å·²åŒæ­¥

                    const response = await fetch('api/import_submission.php', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            email: "jiunhong222@gmail.com", // æš‚æ—¶å†™æ­»
                            challengeTitle: data.challengeTitle,
                            photoUrl: data.photoUrl
                        })
                    });
                    const res = await response.json();
                    if(res.status === 'success') {
                        await updateDoc(doc(db, "submissions", docSnap.id), { synced: true });
                        count++;
                        logBox.innerHTML += `<br>âœ… å·²å½’æ¡£: ${data.challengeTitle}`;
                    }
                }
                
                if (count === 0) logBox.innerHTML += `<br>ğŸ‘Œ æ²¡æœ‰æ–°æ•°æ®éœ€è¦å½’æ¡£`;
                else logBox.innerHTML += `<br>ğŸ‰ æˆåŠŸå½’æ¡£ ${count} æ¡æ•°æ®`;

            } catch (e) {
                logBox.innerHTML += `<br>âŒ é”™è¯¯: ${e.message}`;
            } finally {
                btn.disabled = false;
            }
        };
    </script>

</body>
</html>
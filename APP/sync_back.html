<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>åŒæ­¥ä¸­å¿ƒ: æ•°æ®å½’æ¡£</title>
    <style>
        body { font-family: sans-serif; padding: 40px; text-align: center; background: #fff3e0; }
        button { padding: 15px 30px; background: #E65100; color: white; border: none; border-radius: 5px; font-size: 18px; cursor: pointer; }
        #log { margin-top: 20px; text-align: left; background: white; padding: 20px; border-radius: 8px; }
    </style>
</head>
<body>

    <h1>ğŸ“¥ æ•°æ®å½’æ¡£ä¸­å¿ƒ</h1>
    <p>å°† App äº§ç”Ÿçš„å®æ—¶æ•°æ® (Firebase) æŠ“å–å› MySQL è¿›è¡Œæ°¸ä¹…ä¿å­˜ã€‚</p>
    <button onclick="syncBack()">å¼€å§‹å½’æ¡£ (Firebase -> MySQL)</button>
    <div id="log"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // ğŸ”´ ä½ çš„ Config
        const firebaseConfig = {
            apiKey: "ä½ çš„API_KEY",
            authDomain: "ecotrip-miniproject.firebaseapp.com",
            projectId: "ecotrip-miniproject",
            storageBucket: "ecotrip-miniproject.firebasestorage.app",
            messagingSenderId: "...",
            appId: "..."
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        window.syncBack = async () => {
            const log = document.getElementById('log');
            log.innerHTML = "æ‰«æ Firebase...";

            // 1. æŠ“å– submissions
            const snapshot = await getDocs(collection(db, "submissions"));
            
            for (const docSnap of snapshot.docs) {
                const data = docSnap.data();
                
                // é˜²æ­¢é‡å¤åŒæ­¥ï¼šæ£€æŸ¥æ˜¯å¦æœ‰ 'synced' æ ‡è®°
                if (data.synced) continue;

                log.innerHTML += `<br>ğŸ“¦ å‘ç°æ–°æ•°æ®: ${data.challengeTitle}`;

                // 2. å‘é€ç»™ PHP
                const response = await fetch('api/import_submission.php', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        email: "jiunhong222@gmail.com", // æš‚æ—¶å†™æ­»æˆ–ä» auth è·å–
                        challengeTitle: data.challengeTitle,
                        photoUrl: data.photoUrl
                    })
                });

                const res = await response.json();
                if(res.status === 'success') {
                    log.innerHTML += ` -> âœ… å·²å­˜å…¥ MySQL`;
                    // 3. æ ‡è®°ä¸ºå·²åŒæ­¥
                    await updateDoc(doc(db, "submissions", docSnap.id), { synced: true });
                } else {
                    log.innerHTML += ` -> âŒ å¤±è´¥: ${res.error}`;
                }
            }
            log.innerHTML += "<br><br>ğŸ å½’æ¡£å®Œæˆï¼";
        };
    </script>
</body>
</html>